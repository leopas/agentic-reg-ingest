# ğŸ“Š Diagrama: Armazenamento de URLs Aprovadas

## Fluxo Visual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Upload PDF                                               â”‚
â”‚     upload_id: "07da1342..."                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. OCR + Gemini â†’ JSONL                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. GPT Allowlist â†’ Plan                                     â”‚
â”‚     plan_id: "af46e9f2..."                                   â”‚
â”‚     allow_domains: ["ans.gov.br", "anvisa.gov.br"]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Agentic Search (IteraÃ§Ã£o 1)                              â”‚
â”‚                                                              â”‚
â”‚  Google CSE Search:                                          â”‚
â”‚    - Query 1 â†’ 10 URLs                                       â”‚
â”‚    - Query 2 â†’ 10 URLs                                       â”‚
â”‚                                                              â”‚
â”‚  Judge LLM aprova:                                           â”‚
â”‚    âœ“ https://ans.gov.br/legislacao/rn-123                   â”‚
â”‚    âœ“ https://anvisa.gov.br/norma-456                        â”‚
â”‚    âœ“ https://saude.gov.br/portaria-789                      â”‚
â”‚    ...                                                       â”‚
â”‚                                                              â”‚
â”‚  SALVA EM:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ agentic_iter                                   â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚ id: 1                                          â”‚         â”‚
â”‚  â”‚ plan_id: "af46e9f2..."                         â”‚         â”‚
â”‚  â”‚ iteration_number: 1                            â”‚         â”‚
â”‚  â”‚ approved_urls: [                               â”‚         â”‚
â”‚  â”‚   "https://ans.gov.br/legislacao/rn-123",     â”‚         â”‚
â”‚  â”‚   "https://anvisa.gov.br/norma-456",          â”‚         â”‚
â”‚  â”‚   ...                                          â”‚         â”‚
â”‚  â”‚ ]                                              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                              â”‚
â”‚  E TAMBÃ‰M EM (para cada URL):                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ search_result                                  â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚ id: 101                                        â”‚         â”‚
â”‚  â”‚ query_id: 50                                   â”‚         â”‚
â”‚  â”‚ url: "https://ans.gov.br/legislacao/rn-123"   â”‚         â”‚
â”‚  â”‚ title: "ResoluÃ§Ã£o Normativa 123..."           â”‚         â”‚
â”‚  â”‚ snippet: "Esta RN trata de..."                â”‚         â”‚
â”‚  â”‚ score: 0.87                                    â”‚         â”‚
â”‚  â”‚ approved: TRUE                                 â”‚         â”‚
â”‚  â”‚ final_type: "pdf"                              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Vision Upload Vinculado                                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ vision_upload                                  â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚ upload_id: "07da1342..."                       â”‚         â”‚
â”‚  â”‚ plan_id: "af46e9f2..."          â† LIGA TUDO!  â”‚         â”‚
â”‚  â”‚ status: "awaiting_review"                      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. UsuÃ¡rio Revisa URLs (UI)                                 â”‚
â”‚                                                              â”‚
â”‚  GET /vision/approved-urls/{upload_id}                       â”‚
â”‚  â†“                                                           â”‚
â”‚  1. Busca vision_upload por upload_id                        â”‚
â”‚  2. Pega plan_id do upload                                   â”‚
â”‚  3. Busca agentic_iter WHERE plan_id = ...                   â”‚
â”‚  4. Extrai approved_urls do JSON                             â”‚
â”‚  5. Busca search_result WHERE url IN (approved_urls)         â”‚
â”‚  6. Retorna lista com tÃ­tulo, snippet, score                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. Scraping das URLs Selecionadas                           â”‚
â”‚                                                              â”‚
â”‚  POST /vision/scrape/{upload_id}                             â”‚
â”‚  Body: {selected_urls: ["url1", "url2"]}                     â”‚
â”‚                                                              â”‚
â”‚  Para cada URL:                                              â”‚
â”‚    - Faz scraping                                            â”‚
â”‚    - Salva .txt em data/output/enrichment_txt/               â”‚
â”‚    - Atualiza chunk_manifest                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Relacionamentos de Tabelas

```
vision_upload
    â†“ (plan_id)
agentic_plan
    â†“ (plan_id)
agentic_iter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  â”‚
    â”‚ approved_urls    â”‚ (JSON array)
    â”‚ (JSON)           â”‚
    â”‚                  â”‚
    â†“                  â†“
search_result    (usa as URLs do JSON para buscar detalhes)
    â”‚
    â”‚ url, title, snippet, score
    â”‚
    â†“
chunk_manifest (depois do scraping)
    â”‚
    â”‚ doc_hash, canonical_url
    â”‚
    â†“
Qdrant (vector database)
```

---

## ğŸ” Como Recuperar URLs

### **MÃ©todo 1: Via agentic_iter (JSON)**

```sql
SELECT approved_urls 
FROM agentic_iter 
WHERE plan_id = 'af46e9f2...'

-- Retorna: ["url1", "url2", "url3"]
```

### **MÃ©todo 2: Via search_result (Detalhes Completos)**

```sql
SELECT url, title, snippet, score 
FROM search_result 
WHERE approved = TRUE 
  AND url IN (
    -- URLs do agentic_iter
    SELECT JSON_UNQUOTE(JSON_EXTRACT(approved_urls, '$[*]'))
    FROM agentic_iter 
    WHERE plan_id = 'af46e9f2...'
  )
```

### **MÃ©todo 3: Via Code (Usado no projeto)**

```python
# apps/api/routes_vision_enrichment.py:429-442

# 1. Busca iteraÃ§Ãµes
iters = AgenticIterDAO.get_iters(session, plan_id)

# 2. Coleta URLs do JSON
all_approved_urls = set()
for iteration in iters:
    all_approved_urls.update(iteration.get("approved_urls", []))

# 3. Busca detalhes em search_result
stmt = select(SearchResult).where(SearchResult.url.in_(all_approved_urls))
results = session.scalars(stmt)
```

---

## âœ… ProteÃ§Ã£o Contra Duplicatas Implementada

**Antes:**
```python
# âŒ Sempre cria novo
session.add(SearchResult(...))
```

**Agora:**
```python
# âœ… Verifica se existe
existing = session.query(SearchResult).filter_by(
    query_id=query_id, 
    url=url
).first()

if existing:
    # Atualiza
    existing.score = new_score
else:
    # Cria novo
    session.add(SearchResult(...))
```

---

## ğŸ¯ Resultado

Agora, mesmo se o Agentic Search retornar a mesma URL em mÃºltiplas iteraÃ§Ãµes:
- âœ… **NÃ£o vai duplicar** na mesma query
- âœ… **Atualiza** o score/rank se a URL aparecer novamente
- âœ… **MantÃ©m histÃ³rico** se aparecer em queries diferentes

**Problema resolvido!** ğŸ‰

